import os
import random
import threading
from flask import Flask
import discord
from discord.ext import commands

# --- Flask サーバー設定（Renderで常時稼働させる用） ---
app = Flask(__name__)

@app.route('/')
def home():
    return "Bot is alive!"  # UptimeRobotがこのURLを監視する

def run_web():
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port)

intents = discord.Intents.default()
intents.message_content = True 

bot = commands.Bot(command_prefix="", intents=intents)

@bot.event
async def on_ready():
    print(f"ログインしました：{bot.user}")

@bot.event
async def on_message(message):
    if message.author.bot:
        return
      
    allowed_channels = [1430934836138479728, 1430744714369306624]
    if message.channel.id not in allowed_channels:
       return


    content = message.content.lower()


    # ランダム返信
    replies = [ "カーレス：イカれたメンバーを紹介するで！部屋がめっちゃ暑くて風がないってときに、「ドライアイス買ってきて置いときゃ冷えるんやない？」と部屋を閉めきってドライアイス置いといたら全員で無理心中しかけた私、ルーチェ、ハル、ソラ、ウィンディ、クロス！以上や！今回も盛り上がっていこうやぁ！！",
        "ウィンディ：「寝起きでも分かるように個別に携帯の着信音設定してる」ってクロスが言うから、私が呼び出したらピタゴラスイッチのテーマが流れ出したのはまだ平静を保ててんけど、ソラが呼び出したら法螺貝の音が鳴り響くのは何なん？出陣なん？",
        "ファルル：ツタンカーメンみたいな形の毛布があったから片付けようとしたら、中にカーレス入ってた。",
        "ルーチェ：こんな…こんな、ただ敷かれたレールの上をトロッコに乗って走り、時々落ちてくる岩や置いてある木をジャンプでかわし、要所要所のスピードアップアイテムを取って加速してゴールを目指すだけの人生なんて...\nウィンディ：楽しそうやな。",
        "クロス：私に喧嘩売ったら腕の3本や4本じゃ済まさへんで。\nソラ：腕そんなにねーわ。",
        "カーレス：今窓からハチが入ってきてパニックになってたら、何故かソラがうちわを手に取った。（風で撃退するつもりなんか!？いや、無理やろ！）と思ってたら、無言でおもむろにうちわを縦にして勢いよくハチを叩き切った。流石は近衛騎士の家系。",
        "カーレス：なあハル！今すごく余計なこと思い付いた！\nファルル：うん、黙ろっかー。",
        "ファルル：一番いい遅刻の言い訳した人は許したんで。\nルーチェ：じ、人生という名の道に迷ってさ…。\nウィンディ：いやー、急に朝が来ちゃってさー、あっはっは。\nカーレス：私が遅れたんやない！皆がはよ来すぎたんや！\nクロス：ハルの怒った顔も見てみたかってん。やっぱ思っとった通りかっこええな。\nソラ：私も見てみたかったから、ハルの部屋に悪戯仕掛けててん。\nファルル：全員許さん。あとソラ、解除して！",
        "ソラ：ウィンディが風魔法使ってるのにミニドレスやったから、「この風で大丈夫なんか？」って訊いたら、「スパッツ履いてるから平気やで！」と目の前でスカートを捲った。その行為にもまずツッコミを入れたいねんけど、スパッツに「残念だったな」という文字が印刷されていた。何やそれ…？何処で売っとるん？",
        "クロス：受験の時は、鉛筆を最低三本は持ってくとええで。一つはメインで使う用、一つは周囲の動揺を誘うため試験開始と共にへし折る用。もう一つは予備や。",
        "ソラ：口裂け女に会ったときは、「ポマード」と大きく三回唱えればいい、とさっきハルに聞いた。姉様は、「体の真ん中、胸の下あたりを全力で殴ればいい」って言ってたけどなぁ。",
        "ウィンディ：ハルが寝言で「ストライク！ストライク！ストライク！ストライク！」と連呼してたから、「バッターアウト！」と言ってみたら止まった。",
        "ルーチェ：すごい疲れた時、「こんなメンタルやし、王女なんて向いてないんかも知れへん」っていう相談をクロスにしたら、「何言っとんの、まずは小さいとこから自信をつけてこーや。殺人鬼やって、最初は小さな虫から始まって最後に人を殺すやろ？」というロック&クレイジーなアドバイスが返ってきた。",
        "ウィンディ：しましまの仔猫がモンスターに襲われてぼろぼろになってるのを発見して、ハルと動物病院に行ったら、医者が深刻な顔に。\n医者「これは、傷を縫わねばなりませんが…」\nハル「手術費ですか？それとも難しい手術なんでしょうか？」\n医者「柄がずれます。」\nええから縫ってや！ってハルがぶち切れてたなぁ。あ、モンスターはちゃんと討伐しといたで。",
        "カーレス：何かこう、咲耶の除霊は「お話聞いてあげるからねー帰ろうねーもう大丈夫よー(・ω・`*)ネー」って感じやんな。\nソラ：せやな。サラチア王国はどんなんやったっけ？\nカーレス：サラチアの悪魔祓いは、「此処にお前の席ねぇからーーーーー！！！！！」って感じや。",
        "カーレス：最近空を見上げてるというより空に見下されてる。",
        "ファルル：ルーチェとかウィンディが外交の場で言う「それで？」は、「貴方の言っていることには新情報や示唆が一つもございません。まさかこれで終わりだとは思えませんので、どうぞお話を続けてください。」って意味やから、相手の人は気ぃつけてな。",
        "クロス：白ヤギさんから不意討ち受けた\n        黒ヤギさんたら見もせず避けた\n        余裕があるので煽っておいた\n      さっきの無様な初撃はなあに\nウィンディ：えらい殺伐とした替え歌やなぁ。",
        "ウィンディ：月が綺麗ですね（愛しています）\nファルル：星が綺麗ですね（貴方は私の思いを知らないでしょうね）\nルーチェ：暖かいですね（貴方が傍にいてくれて幸せです）\nソラ：雨音が響いていますね（愛していました）\nクロス：明日の月は綺麗でしょうね（貴方を殺す）\nカーレス：ﾀﾞｧｼｴﾘｲｪｽ！（ドアが閉まります）←NEW！",
        "ルーチェ：さっき見かけたカーレスがほうき乗りながら生ハム食べてたんやけど、あんなことするん世界でカーレスだけやと思う。"]
    await message.channel.send(random.choice(replies))


     # トークンを環境変数から取得
def run_bot():
    TOKEN = os.getenv("TOKEN")
    if not TOKEN:
        raise SystemExit("TOKEN environment variable not set")
    bot.run(TOKEN)

if __name__ == "__main__":
    threading.Thread(target=run_web).start()
    run_bot()
